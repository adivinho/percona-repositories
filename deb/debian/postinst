#!/bin/bash
# postinst script for percona-release
#
# see: dh_installdeb(1)
SUPRESSOR="> /dev/null 2>&1"
OLDREPOFILE="/etc/apt/sources.list.d/percona-release.list"

if [ "${PERCONA_DEBUG}" = "1" ]; then
  set -x
  SUPRESSOR=""
fi

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
      eval "/usr/bin/apt-key add /usr/share/keyrings/percona-keyring.gpg  ${SUPRESSOR}"
      if [ -f /etc/default/percona-release ]; then
          . /etc/default/percona-release
      fi
      if [ "${REPOSITORIES}" == "" ]; then
          REPOSITORIES="prel telemetry"
      fi
      /usr/bin/percona-release enable prel release || true
      /usr/bin/percona-release enable telemetry release || true
      if [[ -f  ${OLDREPOFILE} ]]; then
        mv -f ${OLDREPOFILE} ${OLDREPOFILE}.bak
      fi
      for file in $(find /etc/apt/sources.list.d/ -mmin -3 -type f -iname "percona*.list.bak" -not -iname "*prel-release*"); do
        new_file=$(echo $file | sed 's/.bak//')
	if [[ $new_file != ${OLDREPOFILE} ]]; then
          mv $file $new_file
        fi
      done

cat << EOF
The percona-release package now contains a percona-release script that can enable additional repositories for our newer products.

Note: currently there are not any enabled repositories that contain Percona products or distributions. We recommend you enabling Percona Distribions instead of separate product repos as in this case you will get not only database itself but a set of other commponets that will help you working with your database.

For example, to enable the Percona Distribution for MySQL 8.0 repository use:

  percona-release setup pdps8.0

Note: To avoid conflicts with older product versions, the percona-release setup command may disable our original repository for some products.

For more information, please visit:
  https://docs.percona.com/percona-software-repositories/percona-release.html

EOF
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
